# üéØ Plan de Implementaci√≥n QR - Ready para Antigravity

**Objetivo**: Transformar tu registro manual a sistema 100% digital con QR en 6 horas. Copia cada instrucci√≥n exactamente como aparece.

---

## **SETUP INICIAL (30 minutos - TU control total)**

### Paso 0: Inicializar Proyecto Seguro
```bash
# Instala Antigravity primero: antigravity.google/download
# Luego ejecuta esto en tu terminal:

antigravity init parking-qr-system --python --security-policy=restricted
```

### Paso 1: Configurar Pol√≠ticas de Seguridad (CR√çTICO)
**Instrucci√≥n para Antigravity:**
```
/set-security-policy terminal=ask-before-execute
/set-security-policy code-review=on
/block-commands rm,sudo,curl,wget
/set-auto-backup db=hourly,path=./backups
```
**Marca de control:** ‚úÖ Antes de continuar, revisa que se cre√≥ la carpeta `/backups`

---

## **FASE 1: MODELO DE DATOS QR (45 min - AGENTE)**

### Paso 2: Crear Base de Datos y Modelos
**Copia y pega esto EXACTAMENTE:**
```
/CREATE-TASK-BLOCK "Modelo de Datos QR"

1. Dise√±a tabla rates con campos: id, vehicle_type, hourly_rate, is_active
2. Dise√±a tabla parking_sessions con campos: id, qr_token, plate, vehicle_type, brand, color, details, entry_time, exit_time, total_paid
3. qr_token debe ser UNIQUE STRING de 12 caracteres en formato PK-XXXX-YYYY
4. Genera migraci√≥n Alembic (SQLAlchemy)
5. Crea script seeds.py con 3 tarifas: automovil=20, moto=10, camioneta=25
6. Ejecuta migraci√≥n y verifica con SELECT * FROM tables

/ASSIGN-AGENT "Database Engineer"
/SET-PRIORITY high
/EXECUTE
```

**Marca de control:** ‚úÖ Ejecuta `sqlite3 parking.db ".schema"` y verifica las tablas

---

## **FASE 2: BACKEND QR (90 min - AGENTE)**

### Paso 3: Sistema de Tokens y Generaci√≥n QR
**Instrucci√≥n para Antigravity:**
```
/CREATE-TASK-BLOCK "Backend QR Generator"

1. Instala dependencias: qrcode[pil], pillow, sqlalchemy
2. Crea qr_generator.py con clase QRManager que:
   - Genere tokens √∫nicos PK-AAAA-BBBB
   - Cree imagen PNG con logo (static/img/logo.png)
   - Guarde en carpeta static/qr_codes/
3. Crea endpoint POST /api/entry con body:
   {plate, vehicle_type, brand, color, details}
4. El endpoint debe:
   - Validar formato de placa mexicana AAA-123
   - Generar qr_token
   - Insertar en parking_sessions
   - Retornar {success: true, qr_path, token, entry_time}
5. Implementa validaci√≥n de tipos de veh√≠culo contra tabla rates
6. Genera 5 tests unitarios con pytest

/ASSIGN-AGENT "Backend Developer"
/EXECUTE
```

### Paso 4: API de Verificaci√≥n y Salida
**Instrucci√≥n para Antigravity:**
```
/CREATE-TASK-BLOCK "API Verificaci√≥n QR"

1. Endpoint GET /api/verify-qr/<token>
2. Si encontrado y sin exit_time: retorna datos completos + tiempo transcurrido
3. Si ya egres√≥: retorna error 410 "Veh√≠culo ya retirado"
4. Si no existe: retorna error 404
5. Endpoint POST /api/exit con body: {token, exit_time}
6. Calcula total: ceil(minutos/15) * tarifa/4
7. Retorna {total_amount, hours_parked, rate_used}
8. Incluye manejo de CORS y rate limiting (10 req/seg)

/ASSIGN-AGENT "API Security"
/EXECUTE
```

**Marca de control:** ‚úÖ Prueba con Postman: `POST /api/entry` con datos de prueba

---

## **FASE 3: FRONTEND M√ìVIL (90 min - AGENTE)**

### Paso 5: Ticket Digital (Pantalla del Cliente)
**Instrucci√≥n para Antigravity:**
```
/CREATE-TASK-BLOCK "UI Ticket Digital"

1. Crea template ticket_digital.html con:
   - QR 300x300px centrado
   - Placa en H1 tama√±o 32px
   - Hora de entrada, tipo, marca
   - Bot√≥n "Descargar Ticket" usando html2canvas
   - Bot√≥n "Compartir por WhatsApp" (web Share API)
2. Dise√±o responsive: max-width 400px, margen auto
3. CSS para impresi√≥n t√©rmica 58mm: @media print { ... }
4. Script JS que convierte ticket a PNG y trigger descarga
5. Incluye meta viewport y PWA manifest para "Agregar a pantalla"

/ASSIGN-AGENT "Frontend Designer"
/DESIGN-THEME "mobile-first, dark-mode optional"
/EXECUTE
```

### Paso 6: Esc√°ner QR para Salida
**Instrucci√≥n para Antigravity:**
```
/CREATE-TASK-BLOCK "Scanner QR Salida"

1. Usa librer√≠a html5-qrcode@2.3.8 desde CDN
2. Crea scan_exit.html con:
   - Div #reader (c√°mara en vivo)
   - Overlay con cuadro de escaneo
   - Bot√≥n "Escribir Placa Manual" (fallback)
3. Al escanear: 
   - FETCH a /api/verify-qr/<token>
   - Muestra modal con datos del veh√≠culo
   - Muestra tiempo estacionado y monto
   - Bot√≥n rojo "Confirmar Salida" con confirmaci√≥n
4. Si error: muestra mensaje con vibraci√≥n (navigator.vibrate)
5. Al confirmar: POST a /api/exit y muestra recibo
6. Prueba en 3 dispositivos m√≥viles (emulador de Antigravity)

/ASSIGN-AGENT "Mobile Developer"
/TEST-ON devices=["iPhone 13", "Samsung S22", "Xiaomi Note 10"]
/EXECUTE
```

**Marca de control:** ‚úÖ Escanea un QR de prueba desde tu m√≥vil. Debe mostrar datos.

---

## **FASE 4: FLUJO COMPLETO (45 min - TU DIRECCI√ìN)**

### Paso 7: Dashboard Principal
**Instrucci√≥n para Antigravity:**
```
/CREATE-TASK-BLOCK "Dashboard Principal"

1. Index.html con 2 botones grandes (80vh cada uno):
   - üöó Nuevo Ingreso -> redirige a /register
   - üì∑ Escanear Salida -> redirige a /scan_exit
2. Barra superior con:
   - Total veh√≠culos activos (live count)
   - Link a /reports
3. Footer sticky con:
   - √öltimo registro: placa + hora
   - Ingresos del d√≠a: $0.00 (actualiza cada 30 seg)
4. Implementa SSE (Server-Sent Events) para updates en tiempo real
5. Guarda en localStorage √∫ltimos 10 tickets por si falla conexi√≥n

/ASSIGN-AGENT "UX Engineer"
/DECISION-REQUIRED layout=["botones verticales", "botones horizontales"]
/EXECUTE
```

**TU DECISI√ìN:** Elige layout en el chat de Antigravity antes de ejecutar.

---

## **FASE 5: REPORTES Y BACKUP (30 min - AGENTE)**

### Paso 8: Sistema de Reportes
**Instrucci√≥n para Antigravity:**
```
/CREATE-TASK-BLOCK "Reportes Diarios"

1. Endpoint /api/reports/daily?date=YYYY-MM-DD
2. Retorna JSON: {total_vehicles, total_revenue, avg_time, per_type}
3. Template reports.html con:
   - Date picker
   - Tabla sortable de registros
   - Bot√≥n "Exportar Excel" (sheetjs)
   - Bot√≥n "Imprimir Resumen"
4. Query SQL optimizada con √≠ndices en entry_time, exit_time
5. L√≠mite de 1000 registros por consulta (paginaci√≥n)

/ASSIGN-AGENT "Data Analyst"
/EXECUTE
```

### Paso 9: Backup Autom√°tico
**Instrucci√≥n para Antigravity:**
```
/CREATE-TASK cron="0 */6 * * *" "Backup DB"

1. Crea script backup.py que:
   - Haz dump de parking.db
   - Comprime con ZIP + fecha
   - Guarda en /backups/ (m√°x 7 archivos)
   - Opcional: sube a Google Drive si configuras API key
2. A√±ade endpoint manual /backup-trigger para forzar backup
3. Notifica en dashboard si √∫ltimo backup > 24h

/ASSIGN-AGENT "DevOps"
/EXECUTE
```

---

## **FASE 6: PRUEBAS DE CAMPO (30 min - TU control)**

### Paso 10: Simulaci√≥n de D√≠a Completo
**Instrucci√≥n para Antigravity:**
```
/CREATE-TEST "Simulaci√≥n Estacionamiento"

1. Crea script simulate_day.py que genere 20 registros aleatorios
2. Simula entradas cada 5 minutos
3. Simula salidas aleatorias despu√©s de 1-4 horas
4. Verifica que todos los c√°lculos sean correctos
5. Genera reporte de consistencia: SUM(total_paid) vs manual
6. Exporta log de errores si los hay

/EXECUTE
```

**Marca de control:** ‚úÖ Revisa reporte. ¬øLos totales coinciden con tu c√°lculo manual?

---

### Paso 11: Checklist de Despliegue (TU responsabilidad)
**Instrucci√≥n para Antigravity:**
```
/GENERATE-CHECKLIST "Pre-Production"

1. Verificar que impresora t√©rmica est√© conectada (si aplica)
2. Probar en red local: ipconfig/ifconfig para obtener IP
3. Configurar firewall: permitir puerto 5000
4. Crear acceso directo en pantalla de smartphones del personal
5. Imprimir 5 tickets QR de prueba
6. Testear escaneo con 3 dispositivos diferentes
7. Validar backup se crea correctamente
8. Entrenar al personal (genera gu√≠a r√°pida de 1 p√°gina)

/OUTPUT-FORMAT markdown+checkboxes
```

---

## **üéÆ MODO DIRECTOR: C√≥mo Usar Antigravity**

### **Comandos que T√ö usar√°s:**

| Comando | Cu√°ndo usar | Qu√© hace |
|---------|-------------|----------|
| `/status` | Cada 30 min | Ve progreso de tareas |
| `/pause-task [id]` | Si algo sale mal | Detiene ejecuci√≥n |
| `/review-code [file]` | Antes de aprobar | Muestra diff de cambios |
| `/approve [task]` | Despu√©s de revisar | Guarda y contin√∫a |
| `/rollback [commit]` | Si hay error cr√≠tico | Vuelve a versi√≥n anterior |
| `/generate-docs` | Al final | Crea manual de usuario |

### **Decisiones que DEBES tomar:**

1. **Dentro de 45 min**: Layout del dashboard (Paso 7)
2. **Dentro de 2 horas**: Revisar c√≥digo de generaci√≥n de QR (Paso 3)
3. **Dentro de 4 horas**: Aprobar dise√±o del ticket digital (Paso 5)
4. **Al final**: Tipo de backup (local solo o cloud tambi√©n)

---

## **üìä M√âTRICAS DE √âXITO**

**Antigravity reportar√° estas m√©tricas autom√°ticamente:**
```json
{
  "development_time": "5.5 horas",
  "code_generated": "~450 l√≠neas",
  "test_coverage": "85%",
  "api_endpoints": 6,
  "ui_screens": 4,
  "security_checks": "pass"
}
```

‚úÖ **Tu meta**: Registrar 10 veh√≠culos en <15 minutos cada uno con 0 errores.

---

## **üö® PROTOCOLO DE EMERGENCIA**

Si algo falla en producci√≥n:
```
/DIAGNOSE-ERROR "Descripci√≥n del problema"
/EMERGENCY-FIX "Rollback √∫ltimo cambio"
/SWITCH-TO-MODE manual=True
```

---

**Instrucci√≥n final para iniciar TODO:**
```
antigravity start-project --plan=parking-qr-system --auto-approve-setup=false
```

Copia eso, p√©galo en Antigravity, y **t√∫ controlas cada aprobaci√≥n**. ¬øListo para empezar?